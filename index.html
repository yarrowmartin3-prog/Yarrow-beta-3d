<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Yarrow Assistant</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: Arial, sans-serif; margin:0; padding:20px; text-align:center; background:#f5f5f5; }
    h1 { margin:10px 0 16px; }
    .avatar { width:110px; height:110px; border-radius:50%; object-fit:cover; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.15); }
    .row { display:flex; gap:10px; justify-content:center; align-items:center; margin:12px 0; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #bbb; background:#fff; }
    button.small { padding:8px 12px; }
    button.primary { background:#4caf50; color:#fff; border:0; }
    #voiceSelect { padding:8px; border-radius:8px; border:1px solid #bbb; }
    #capabilities { color:#555; margin-bottom:10px; }
    #output { margin:14px auto; max-width:640px; min-height:1.2em; }
  </style>
</head>
<body>
  <h1>🌱 Yarrow Assistant</h1>

  <!-- Compatibilité -->
  <p id="capabilities">Chargement...</p>

  <!-- Avatar + choix -->
  <img id="assistantAvatar" src="assistant-1.png" alt="Assistant" class="avatar">
  <div class="row">
    <button class="small" data-src="assistant-1.png">🙂</button>
    <button class="small" data-src="assistant-2.png">🤖</button>
    <button class="small" data-src="assistant-3.png">🧑‍🔧</button>
  </div>

  <!-- Voix -->
  <div class="row">
    <label for="voiceSelect">Voix :</label>
    <select id="voiceSelect"><option>(chargement)</option></select>
    <button id="start-voice" class="primary">🎤 Parler</button>
    <button id="test-tts">🔊 Tester la voix</button>
  </div>

  <p id="output"></p>

  <script>
    // -------- CONFIG --------
    const API_BASE = "https://yarrow-ai-server.vercel.app"; // mets ici ton URL Vercel exacte si différente

    // -------- UTIL --------
    const $ = id => document.getElementById(id);
    const setText = (el, t) => el && (el.textContent = t);

    // -------- SELECTEURS --------
    const startBtn = $("start-voice");
    const output = $("output");
    const capabilities = $("capabilities");
    const voiceSelect = $("voiceSelect");
    const avatarImg = $("assistantAvatar");

    // -------- COMPATIBILITÉ --------
    const supportsRecognition = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
    const supportsSynthesis = "speechSynthesis" in window;

    if (supportsRecognition && supportsSynthesis) {
      setText(capabilities, "✅ Compatible : écoute et voix disponibles");
    } else if (supportsRecognition) {
      setText(capabilities, "⚠️ Écoute seulement, pas de voix");
    } else if (supportsSynthesis) {
      setText(capabilities, "⚠️ Voix seulement, pas d’écoute (utilise Chrome Android pour le micro)");
    } else {
      setText(capabilities, "❌ Pas compatible sur ce navigateur");
    }

    // -------- AVATARS --------
    document.querySelectorAll("button[data-src]").forEach(b=>{
      b.addEventListener("click", ()=> { avatarImg.src = b.getAttribute("data-src"); });
    });

    // -------- VOIX --------
    let voices = [];
    function loadVoices(){
      if (!supportsSynthesis) return;
      voices = speechSynthesis.getVoices();
      voiceSelect.innerHTML = "";
      if (!voices.length) {
        const o = document.createElement("option"); o.text = "(aucune voix trouvée)"; voiceSelect.add(o);
        return;
      }
      voices
        .sort((a,b)=>(b.lang.startsWith("fr")-a.lang.startsWith("fr"))||a.name.localeCompare(b.name))
        .forEach(v=>{
          const o = document.createElement("option");
          o.value = v.name; o.text = `${v.name} (${v.lang})`;
          voiceSelect.add(o);
        });
      const fr = voices.find(v=>v.lang.startsWith("fr"));
      if (fr) voiceSelect.value = fr.name;
    }
    if (supportsSynthesis){ loadVoices(); speechSynthesis.onvoiceschanged = loadVoices; }

    // -------- RECONNAISSANCE + IA --------
    if (supportsRecognition){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new SR();
      rec.lang = "fr-FR";
      rec.interimResults = false;

      startBtn.addEventListener("click", ()=>{
        rec.start();
        setText(output,"🎤 J’écoute…");
      });

      rec.addEventListener("result", async (e)=>{
        const transcript = e.results[0][0].transcript;
        setText(output, "👂 J’ai entendu : " + transcript + " — envoi à l’IA…");
        try{
          const r = await fetch(`${API_BASE}/api/chat`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ userText: transcript })
          });
          const data = await r.json();
          const answer = data.answer || "(pas de réponse)";
          setText(output, "🤖 IA : " + answer);

          if (supportsSynthesis){
            const v = voices.find(v=>v.name===voiceSelect.value);
            const utter = new SpeechSynthesisUtterance(answer);
            if (v) utter.voice = v;
            utter.lang = (v && v.lang) || "fr-FR";
            speechSynthesis.cancel();
            speechSynthesis.speak(utter);
          }
        }catch(err){
          setText(output, "❌ Erreur API : " + err);
        }
      });

      rec.addEventListener("end", ()=>{ setText(output, (output.textContent||"") + " (fin de l’écoute)"); });
    }

    // -------- TEST TTS --------
    document.getElementById("test-tts").addEventListener("click", () => {
      if (!("speechSynthesis" in window)) {
        alert("Synthèse vocale non dispo");
        return;
      }
      const u = new SpeechSynthesisUtterance("Bonjour, ceci est un test de la voix.");
      const v = voices.find(v => v.name === voiceSelect.value);
      if (v) u.voice = v;
      u.lang = (v && v.lang) || "fr-FR";
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    });

    // -------- DIAG RAPIDE --------
    window.onerror = (msg, src, line, col, err) => {
      setText(output, "❌ JS error: " + msg);
    };
  </script>
</body>
</html>
